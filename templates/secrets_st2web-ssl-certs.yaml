{{- if .Values.st2web.use_https }}
---
apiVersion: v1
kind: Secret
metadata:
  {{- $name := print .Release.Name "-st2web-ssl-certs" }}
  name: {{ $name }}
  annotations:
    description: StackStorm st2web SSL Certificates
  labels:
    app: st2
    tier: backend
    vendor: stackstorm
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
type: Opaque
data:
  # SSL Cert+Key used to serve HTTPS from st2web (default: auto-generated)
{{- $previous := lookup "v1" "Secret" .Release.Namespace $name }}
{{- if and .Values.st2web.ssl_certifcate .Values.st2web.ssl_certificate_key }}
  ssl_certificate: |
    {{- .Values.st2web.ssl_certificate | b64enc | nindent 4 }}
  ssl_certificate_key: |
    {{- .Values.st2web.ssl_certificate_key | b64enc | nindent 4 }}
{{- else if $previous }}
  ssl_certificate: |
    {{- $previous.data.ssl_certificate | nindent 4 }}
  ssl_certificate_key: |
    {{- $previous.data.ssl_certificate_key | nindent 4 }}
{{- else }}
  {{- $hosts := list .Values.st2web.service.hostname (printf "%s-st2web.%s.svc" .Release.Name .Release.Namespace) | compact }}
  {{- $altNamesDict := dict "altNames" (list) }}
  {{- range $domain := (append "" (.Values.dnsConfig.searches | default (list)) }}
    {{- range $host := $hosts }}
      {{- $_ := printf "%s.%s" $host $domain | trimSuffix "." | append $altNamesDict.altNames | set $altNamesDict "altNames" }}
    {{- end }}
  {{- end }}
  {{- $altNames := append (printf "%s-st2web.%s" .Release.Name .Release.Namespace) $altNamesDict.altNames }}
  {{- $ca := genCA (print .Release.Name "-st2web-ca") 365 }}
  {{- $generated := genSignedCert (print .Release.Name "-st2web") nil $altNames 365 $ca }}
  ssl_certificate: |
    {{- $generated.Cert | b64enc | nindent 4 }}
  ssl_certificate_key: |
    {{- $generated.Key | b64enc | nindent 4 }}
{{- end }}
{{- end }}
